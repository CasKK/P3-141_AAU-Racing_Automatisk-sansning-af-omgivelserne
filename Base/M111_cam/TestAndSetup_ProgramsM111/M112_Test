#!/usr/bin/env python3
"""
Live Helios/Helios2 depth heatmap with hover depth (correct mm conversion)
"""
import argparse, time, signal, sys
import numpy as np, cv2
from arena_api.system import system
from arena_api.enums import PixelFormat

# ===================== Mouse state =====================
mouse_x, mouse_y = -1, -1
mouse_inside = False

def mouse_callback(event, x, y, flags, param):
    global mouse_x, mouse_y, mouse_inside
    if event == cv2.EVENT_MOUSEMOVE:
        mouse_x, mouse_y = x, y
        mouse_inside = True
    elif event == cv2.EVENT_MOUSELEAVE:
        mouse_inside = False

# ---------- CLI ----------
def cli():
    p = argparse.ArgumentParser("Helios Heatmap")
    p.add_argument("--buffers", type=int, default=8)
    p.add_argument("--win", default="Helios Heatmap")
    return p.parse_args()

stop_flag = False
def _sigint(_s,_f):
    global stop_flag; stop_flag = True

# ---------- Depth extraction ----------
def get_depth_from_buffer(buf, depth_format):
    h, w, bpp = buf.height, buf.width, buf.bits_per_pixel
    arr = np.ctypeslib.as_array(buf.pdata, shape=(h*w*(bpp//8),))
    if depth_format == "Coord3D_C16":
        return arr.view(np.int16).reshape(h, w)
    px = arr.reshape(h, w, 3)
    return (px[:,:,1].astype(np.int16) << 8) | px[:,:,0].astype(np.int16)

# ===================== Main =====================
if __name__ == "__main__":
    args = cli()
    signal.signal(signal.SIGINT, _sigint)

    devices = system.create_device()
    if not devices:
        print("No Helios found")
        sys.exit(1)
    dev = devices[0]

    nodemap = dev.nodemap

    # ---- Correct depth conversion parameters ----
    nodemap['Scan3dCoordinateSelector'].value = 'CoordinateC'
    z_scale = float(nodemap['Scan3dCoordinateScale'].value)
    z_offset = float(nodemap['Scan3dCoordinateOffset'].value)

    print(f"Z scale  : {z_scale} mm/unit")
    print(f"Z offset : {z_offset}")

    # ---- Pixel format ----
    pf = nodemap['PixelFormat']
    try:
        pf.value = PixelFormat.Coord3D_C16
        depth_fmt = "Coord3D_C16"
    except:
        pf.value = PixelFormat.Coord3D_C16Y8
        depth_fmt = "Coord3D_C16Y8"

    cv2.namedWindow(args.win, cv2.WINDOW_NORMAL)
    cv2.setMouseCallback(args.win, mouse_callback)

    with dev.start_stream(args.buffers):
        while not stop_flag:
            buf = dev.get_buffer()
            depth_raw = get_depth_from_buffer(buf, depth_fmt)
            dev.requeue_buffer(buf)

            # ---- Simple visualization ----
            depth_vis = depth_raw.copy().astype(np.float32)
            depth_vis[depth_vis < 0] = 0
            depth_vis = np.clip(depth_vis, 0, np.percentile(depth_vis, 99))
            depth_vis = ((depth_vis / depth_vis.max()) * 255).astype(np.uint8)
            img = cv2.applyColorMap(depth_vis, cv2.COLORMAP_TURBO)

            # ===== Hover depth (CORRECT mm) =====
            if mouse_inside:
                h, w = depth_raw.shape
                if 0 <= mouse_x < w and 0 <= mouse_y < h:
                    raw_z = int(depth_raw[mouse_y, mouse_x])

                    if raw_z != -32768 and raw_z > 0:
                        z_mm = (raw_z + z_offset) * z_scale
                        txt = f"Z: {z_mm:.1f} mm"
                    else:
                        txt = "Invalid depth"

                    cv2.drawMarker(
                        img,
                        (mouse_x, mouse_y),
                        (255, 255, 255),
                        cv2.MARKER_CROSS,
                        20,
                        2
                    )

                    cv2.putText(
                        img,
                        txt,
                        (mouse_x + 10, mouse_y - 10),
                        cv2.FONT_HERSHEY_SIMPLEX,
                        0.6,
                        (255, 255, 255),
                        2,
                        cv2.LINE_AA
                    )

            cv2.imshow(args.win, img)
            if cv2.waitKey(1) & 0xFF in (27, ord('q')):
                break

    cv2.destroyAllWindows()
    system.destroy_device()
